<div class="calc-page">
  <div class="calc-page__header">
    <h1>Site Settings</h1>
    <p>Configure your logo, site name, and branding that appears across all calculators.</p>
  </div>

  <div class="calc-page__body">
    <% if (saved) { %>
      <div class="alert alert-info" style="margin-bottom: var(--space-lg);">
        Settings saved successfully.
      </div>
    <% } %>

    <!-- Current Logo Preview -->
    <div class="calc-section">
      <h2>Current Logo</h2>
      <div style="padding: var(--space-lg); background: var(--color-gray-50); border-radius: var(--border-radius); text-align: center;">
        <img src="<%= config.logo.src %>" alt="<%= config.logo.alt %>" style="max-width: <%= config.logo.width %>px; height: auto;" onerror="this.outerHTML='<span class=text-muted>No logo uploaded yet</span>'">
      </div>
    </div>

    <!-- Upload New Logo -->
    <div class="calc-section">
      <h2>Upload Logo</h2>
      <form action="/settings/logo" method="POST" enctype="multipart/form-data">
        <div class="form-grid" style="grid-template-columns: 1fr auto;">
          <div class="form-group">
            <label>Logo Image (PNG, JPG, SVG, WebP ‚Äî max 2MB)</label>
            <input type="file" name="logo" accept="image/png,image/jpeg,image/svg+xml,image/webp" required>
          </div>
          <div class="form-group" style="justify-content: flex-end;">
            <button type="submit" class="btn btn-primary">Upload Logo</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Site Configuration -->
    <div class="calc-section">
      <h2>Site Configuration</h2>
      <form action="/settings/update" method="POST">
        <div class="form-grid">
          <div class="form-group">
            <label for="siteName">Site Name</label>
            <input type="text" id="siteName" name="siteName" value="<%= config.siteName %>">
          </div>
          <div class="form-group">
            <label for="companyName">Company Name</label>
            <input type="text" id="companyName" name="companyName" value="<%= config.companyName %>">
          </div>
          <div class="form-group">
            <label for="logoWidth">Logo Max Width (px)</label>
            <input type="number" id="logoWidth" name="logoWidth" value="<%= config.logo.width %>" min="40" max="400">
          </div>
        </div>
        <div class="action-bar">
          <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
      </form>
    </div>

    <!-- AI Configuration -->
    <div class="calc-section">
      <h2>AI Configuration</h2>
      <p style="font-size: 0.88rem; color: var(--color-gray-500); margin-bottom: var(--space-md);">
        Configure an AI provider for enhanced features across the site (e.g. Variable Income Analyzer).
        Your API key is stored securely on the server and never sent to the browser.
      </p>

      <form id="aiSettingsForm" action="/settings/ai" method="POST">
        <div class="form-grid">
          <div class="form-group">
            <label for="aiProvider">AI Provider</label>
            <select id="aiProvider" name="aiProvider">
              <option value="" <%= maskedAi.provider === '' ? 'selected' : '' %>>None (disabled)</option>
              <option value="openai" <%= maskedAi.provider === 'openai' ? 'selected' : '' %>>OpenAI</option>
              <option value="anthropic" <%= maskedAi.provider === 'anthropic' ? 'selected' : '' %>>Anthropic</option>
            </select>
          </div>
          <div class="form-group">
            <label for="aiApiKey">API Key</label>
            <div style="display: flex; gap: var(--space-xs);">
              <input type="password" id="aiApiKey" name="aiApiKey"
                     value="<%= maskedAi.hasKey ? maskedAi.apiKeyMasked : '' %>"
                     placeholder="<%= maskedAi.hasKey ? 'Key saved ‚Äî enter new key to replace' : 'Paste your API key' %>"
                     style="flex: 1;"
                     autocomplete="off">
              <button type="button" class="btn btn-secondary" id="aiToggleKey" title="Show / hide key" style="padding: 0.4rem 0.6rem; font-size: 0.85rem;">üëÅ</button>
            </div>
          </div>
        </div>

        <div style="display: flex; align-items: center; gap: var(--space-sm); margin-top: var(--space-md); flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary">Save AI Settings</button>
          <button type="button" class="btn btn-secondary" id="aiTestBtn">Test Connection</button>
          <% if (maskedAi.hasKey) { %>
            <button type="button" class="btn btn-secondary" id="aiClearBtn" style="color: var(--color-danger, #dc3545); border-color: var(--color-danger, #dc3545);">Clear API Key</button>
          <% } %>
          <span id="aiTestResult" style="font-size: 0.85rem; margin-left: var(--space-sm);"></span>
        </div>
      </form>

      <% if (maskedAi.hasKey) { %>
        <div style="margin-top: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--color-gray-50); border-radius: var(--border-radius); font-size: 0.85rem;">
          <strong>Status:</strong> <span style="color: #2d6a4f;">‚úì API key configured</span>
          &nbsp;¬∑&nbsp; Provider: <strong><%= maskedAi.provider === 'openai' ? 'OpenAI' : maskedAi.provider === 'anthropic' ? 'Anthropic' : 'None' %></strong>
          &nbsp;¬∑&nbsp; Key: <code><%= maskedAi.apiKeyMasked %></code>
        </div>
      <% } %>
    </div>
  </div>
</div>
